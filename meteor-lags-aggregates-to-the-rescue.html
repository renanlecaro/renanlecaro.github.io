<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Meteor lags ? Aggregates to the rescue ! - Renan LE CARO</title><meta name="description" content="My app has 4 main collections in mongo : - A user has many weeks and clients - Each week has many orders, one per client, where the order content is stored (can be empty if the client didn't order that week). Initially, my documents&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://lecaro.me/meteor-lags-aggregates-to-the-rescue.html"><link rel="alternate" type="application/atom+xml" href="https://lecaro.me/feed.xml"><link rel="alternate" type="application/json" href="https://lecaro.me/feed.json"><meta property="og:title" content="Meteor lags ? Aggregates to the rescue !"><meta property="og:site_name" content="Renan LE CARO"><meta property="og:description" content="My app has 4 main collections in mongo : - A user has many weeks and clients - Each week has many orders, one per client, where the order content is stored (can be empty if the client didn't order that week). Initially, my documents&hellip;"><meta property="og:url" content="https://lecaro.me/meteor-lags-aggregates-to-the-rescue.html"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@RenanLeCaro"><meta name="twitter:title" content="Meteor lags ? Aggregates to the rescue !"><meta name="twitter:description" content="My app has 4 main collections in mongo : - A user has many weeks and clients - Each week has many orders, one per client, where the order content is stored (can be empty if the client didn't order that week). Initially, my documents&hellip;"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>:root {
              --body-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --heading-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --logo-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --menu-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
           }</style><link rel="stylesheet" href="https://lecaro.me/assets/css/main.css?v=adf9c646ca416aff97afd632c9133472"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://lecaro.me/meteor-lags-aggregates-to-the-rescue.html"},"headline":"Meteor lags ? Aggregates to the rescue !","datePublished":"2021-03-26T23:16","dateModified":"2021-03-26T23:21","description":"My app has 4 main collections in mongo : - A user has many weeks and clients - Each week has many orders, one per client, where the order content is stored (can be empty if the client didn't order that week). Initially, my documents&hellip;","author":{"@type":"Person","name":"Renan LE CARO"},"publisher":{"@type":"Organization","name":"Renan LE CARO"}}</script><style>.hero {
    height: auto;
    margin-top: 200px;
  }
.hero__content {
    position: initial;
    transform: none;
}</style></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://lecaro.me/">Renan LE CARO</a><nav class="navbar js-navbar"><ul class="navbar__menu"><li><a href="https://lecaro.me/hi-im-renan.html" target="_self">About</a></li><li><a href="https://lecaro.me/" target="_self">Posts</a></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2021-03-26T23:16">March 26, 2021</time></div><h1>Meteor lags ? Aggregates to the rescue !</h1></div></header></div><div class="wrapper post__entry"><p>My app has 4 main collections in mongo : </p><p>- A <strong>user </strong>has many <strong>weeks </strong>and <strong>clients</strong></p><p>- Each week has many <strong>orders</strong>, one per client, where the order content is stored (can be empty if the client didn't order that week). </p><p>Initially, my documents were quite dry, I was doing the "joins" work on the client. It got laggy though, so I moved the joins logic to the meteor server, with <strong>hooks</strong> (<strong>matb33:collection-hooks) </strong>in every directions to keep denormalized fields in sync. </p><figure class="post__image"><img loading="lazy" src="https://trello-attachments.s3.amazonaws.com/605b848835c8f765d6d4626e/1025x564/5235adb0e560fb8de807e8488b2e67ec/image.png" data-is-external-image="true" alt="My mess of hooks, simplified, visualized" width="718" height="395"></figure><p>It was a pain though, really hard to follow what was going on and to debug. </p><p>There's also potential for chain reactions and never ending hooks loops. </p><p>But mostly, it was <strong>buggy in edge cases</strong>. </p><p>So I'm migrating away from those hooks, and creating an aggregation pipeline per collection (week, client, order) that computes all the dynamic fields for some given ids, and returns the documents where the value is different, plus some additional ids to check in the next pass. </p><p>It's not yet in production, but after this rewrite, my e2e tests are passing. </p><p>Meteor uses mongodb 4.2 in development server. I didn't feel like forcing an update to 4.4, which brings in two very useful features for my use case (the<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/function/"> $function</a> operator and the ability to <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#output-to-the-same-collection-that-is-being-aggregated">$merge</a> to the collection that you are aggregating on).</p><p>So I've been $writing:{ $some: {$nested: {$queries:'It's a pain''}}} . I'm back to junior level of mastery in this new paradigm, where "It works" comes as a surprise. I'm sure i'll rewrite those ugly aggregations at some point, but for now they seem to do the job. </p><p>One nice approach to using aggregation pipelines in meteor is to declare them in a separate js file, and then have a simple, non-meteor script that runs the aggregation and logs the results. </p><p>I use nodemon to watch the files, and get a very fast feedback loop, without the need to wait for the meteor server to recompile. Great when you're learning as you go. </p><p>I start the script like this (-r esm allows me to use modern imports) </p><pre>nodemon -e js  -r esm tests/scripts/mongofun.js</pre><p> And the script itself is very simple. It just runs the query </p><p>tests/scripts/mongofun.js :</p><pre>const mongoUrl='mongodb://127.0.0.1:3001/meteor'<br><br>async function actual_aggregation(db) {<br>  const result = await db<br>    .collection('Orders')<br>    .aggregate([<br>      {<br>        $match: {_id:'&lt;some test id&gt;'}<br>      }, <br>      ...the_pipeline_imported_from_the_meteor_source<br>    ])<br>    .toArray();<br>  console.log(result);<br>}<br><br>const mongodb = require('mongodb');<br>const client = new mongodb.MongoClient(mongoUrl, {<br>  useUnifiedTopology: true<br>});<br><br>client.connect().then(<br>  async () =&gt; {<br>    const start = Date.now();<br>    await author_aggregation(client.db());<br>    console.log('took ' + (Date.now() - start) + ' ms');<br>  },<br>  e =&gt; console.error(e)<br>);</pre><p>Anyway, that's all for today :)</p></div></article></main><footer class="footer"><div class="footer__copyright"><p>+33 6 28 35 01 14 (Whatsapp only)</p><p><a href="mailto:renan.lecaro@gmail.com">renan.lecaro@gmail.com</a></p></div></footer></div><script async defer="defer" data-domain="lecaro.me" src="https://stats.lecaro.me/js/index.js"></script></body></html>