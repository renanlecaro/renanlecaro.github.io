<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Automating local backups of DO MUP on Ubuntu - Renan LE CARO</title><meta name="description" content="DO + MUP = ðŸ’™ I've migrated my main project, https://ciboulette.net, from Heroku to digital ocean, with the help of the awesome meteor up tool that's still actively maintained. I wanted a way to automate the backups of production to my own computer. In meteor,&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://lecaro.me/automating-backups-of-digital-ocean-meteor-up-install-to-your-ubuntu-workstation.html"><link rel="alternate" type="application/atom+xml" href="https://lecaro.me/feed.xml"><link rel="alternate" type="application/json" href="https://lecaro.me/feed.json"><meta property="og:title" content="Automating local backups of DO MUP on Ubuntu"><meta property="og:site_name" content="Renan LE CARO"><meta property="og:description" content="DO + MUP = ðŸ’™ I've migrated my main project, https://ciboulette.net, from Heroku to digital ocean, with the help of the awesome meteor up tool that's still actively maintained. I wanted a way to automate the backups of production to my own computer. In meteor,&hellip;"><meta property="og:url" content="https://lecaro.me/automating-backups-of-digital-ocean-meteor-up-install-to-your-ubuntu-workstation.html"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@RenanLeCaro"><meta name="twitter:title" content="Automating local backups of DO MUP on Ubuntu"><meta name="twitter:description" content="DO + MUP = ðŸ’™ I've migrated my main project, https://ciboulette.net, from Heroku to digital ocean, with the help of the awesome meteor up tool that's still actively maintained. I wanted a way to automate the backups of production to my own computer. In meteor,&hellip;"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>:root {
              --body-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --heading-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --logo-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --menu-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
           }</style><link rel="stylesheet" href="https://lecaro.me/assets/css/main.css?v=adf9c646ca416aff97afd632c9133472"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://lecaro.me/automating-backups-of-digital-ocean-meteor-up-install-to-your-ubuntu-workstation.html"},"headline":"Automating local backups of DO MUP on Ubuntu","datePublished":"2020-08-04T02:50","dateModified":"2021-03-23T14:17","description":"DO + MUP = ðŸ’™ I've migrated my main project, https://ciboulette.net, from Heroku to digital ocean, with the help of the awesome meteor up tool that's still actively maintained. I wanted a way to automate the backups of production to my own computer. In meteor,&hellip;","author":{"@type":"Person","name":"Renan LE CARO","url":"https://lecaro.me/authors/renan-le-caro/"},"publisher":{"@type":"Organization","name":"Renan LE CARO"}}</script><style>.hero {
    height: auto;
    margin-top: 200px;
  }
.hero__content {
    position: initial;
    transform: none;
}</style></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://lecaro.me/">Renan LE CARO</a><nav class="navbar js-navbar"><ul class="navbar__menu"><li><a href="https://lecaro.me/hi-im-renan.html" target="_self">About</a></li><li><a href="https://lecaro.me/" target="_self">Posts</a></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2020-08-04T02:50">August 4, 2020</time></div><h1>Automating local backups of DO MUP on Ubuntu</h1></div></header></div><div class="wrapper post__entry"><h2>DO + MUP = ðŸ’™</h2><p>I've migrated my main project, <a href="https://www.digitalocean.com/">https://ciboulette.net</a>, from Heroku to <a href="https://www.digitalocean.com/">digital ocean</a>, with the help of the awesome <a href="https://meteor-up.com/">meteor up</a> tool that's still actively maintained.</p><p>I wanted a way to automate the backups of production to my own computer. In meteor, the only thing really worth backing up is the content of the mongoDB.</p><p><strong>We need two things : a script</strong> that does the backup, <strong>and a cron job</strong> to run regularly</p><h2>Backup script</h2><p>You just need to configure the two environment variables at the top (in bold)</p><p><strong>daily_backup.sh</strong></p><pre>#!/bin/sh<br><br># folder where to store the last 7 daily backups, without trailing slash<br>DUMPFOLDER="<strong>/home/renan/cl/app/dump</strong>"<br><br># IP of your digital ocean droplet<br>DO_INSTANCE_IP="<strong>46.101.232.182</strong>"<br><br># so that notifications know on which display to show when called from the cron tab<br>export DISPLAY=:0<br><br># Let it quit when it crash<br>set -e<br><br>DUMPFILE="$DUMPFOLDER/daily_$(date +"%y-%m-%d").backup.gzip"<br><br>if [ ! -f $DUMPFILE ];<br>then<br>  continue<br>else<br>  echo "Already done today" &amp;&amp; exit 0<br>fi<br><br>notify-send "Backing up ..."<br><br># ssh to the instance, then ask the mongodb container to output an archive of all dbs, then stream that back to your machine. <br>ssh "root@$DO_INSTANCE_IP" "docker exec mongodb mongodump --archive --gzip" &gt; "${DUMPFILE}"<br><br># Only keep the last 7 dumps <br>ls -tp $DUMPFOLDER/ | grep -v '/$' | tail -n +8 | xargs -I {} rm -- $DUMPFOLDER/{}<br><br>notify-send "... backup done."</pre><p>Make sure the script is executable with <code>chmod +x daily_backup.sh</code></p><h2>CRON setup</h2><p>We will run this script every hour. The first time it runs it will do the backup, and the next time it will see the file exists already and just exit. The next day the filename will be different and therefore a new backup will be run.Â </p><p>Open the cron editor :Â <code>crontab -e</code>Â </p><p>Add the following line, modifying the path in bold to point to your script.Â Â </p><p><code>1 * * * * /<strong>home/renan/cl/app/.production/daily_backup.sh</strong> &gt;/dev/null 2&gt;&amp;1</code></p><p>This will run the script every hour when minutes are equal to 1, so if you start your computer at 8:30 it will first run at 9:01</p><p>The redirect after the command are to avoid having errors show up in the logs. Ubuntu is a bit confused when cron jobs generate outputs.Â Â </p><h2>How to restore such backup</h2><p>Having backup is nice, but knowing out to restore them is better.Â </p><pre>#!/bin/sh<br><br># folder with the dumps<br>DUMPFOLDER="<strong>/home/renan/cl/app/dump</strong>"<br># IP of your digital ocean droplet<br>DO_INSTANCE_IP="<strong>46.101.232.182</strong>"<br><br># Let it quit when it crash<br>set -e<br><br># find the latest backup file<br>LATEST_FILE=$(ls -t1 "$DUMPFOLDER/" |  head -n 1)<br>LATEST_DUMP="$DUMPFOLDER/$LATEST_FILE"<br>echo "Restoring to production from $LATEST_DUMP"<br>read -p "Press enter to continue .."<br><br># pipe file to the mongorestore inside the mongodb docker container inside the droplet <br>cat "${LATEST_DUMP}" | ssh "root@$DO_INSTANCE_IP" "cat | docker exec -i mongodb mongorestore --archive --gzip --drop"</pre></div></article></main><footer class="footer"><div class="footer__copyright"><p>+33 6 28 35 01 14 (Whatsapp only)</p><p><a href="mailto:renan.lecaro@gmail.com">renan.lecaro@gmail.com</a></p></div></footer></div></body></html>