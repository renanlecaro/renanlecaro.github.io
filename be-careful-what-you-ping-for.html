<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title> Be careful what you ping for - Renan LE CARO</title><meta name="description" content="I have a setup to know when my main app, ciboulette.net, is down. It's based on statuscake, which pings my marketing site every 5 minutes, and also my main app. It used to ping a third endpoint, which was an order form deep inside my&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://lecaro.me/be-careful-what-you-ping-for.html"><link rel="alternate" type="application/atom+xml" href="https://lecaro.me/feed.xml"><link rel="alternate" type="application/json" href="https://lecaro.me/feed.json"><meta property="og:title" content=" Be careful what you ping for"><meta property="og:site_name" content="Renan LE CARO"><meta property="og:description" content="I have a setup to know when my main app, ciboulette.net, is down. It's based on statuscake, which pings my marketing site every 5 minutes, and also my main app. It used to ping a third endpoint, which was an order form deep inside my&hellip;"><meta property="og:url" content="https://lecaro.me/be-careful-what-you-ping-for.html"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@RenanLeCaro"><meta name="twitter:title" content=" Be careful what you ping for"><meta name="twitter:description" content="I have a setup to know when my main app, ciboulette.net, is down. It's based on statuscake, which pings my marketing site every 5 minutes, and also my main app. It used to ping a third endpoint, which was an order form deep inside my&hellip;"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>:root {
              --body-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --heading-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --logo-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
              --menu-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
           }</style><link rel="stylesheet" href="https://lecaro.me/assets/css/main.css?v=adf9c646ca416aff97afd632c9133472"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://lecaro.me/be-careful-what-you-ping-for.html"},"headline":" Be careful what you ping for","datePublished":"2021-03-24T16:49","dateModified":"2021-03-24T16:49","description":"I have a setup to know when my main app, ciboulette.net, is down. It's based on statuscake, which pings my marketing site every 5 minutes, and also my main app. It used to ping a third endpoint, which was an order form deep inside my&hellip;","author":{"@type":"Person","name":"Renan LE CARO"},"publisher":{"@type":"Organization","name":"Renan LE CARO"}}</script><style>.hero {
    height: auto;
    margin-top: 200px;
  }
.hero__content {
    position: initial;
    transform: none;
}</style></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://lecaro.me/">Renan LE CARO</a><nav class="navbar js-navbar"><ul class="navbar__menu"><li><a href="https://lecaro.me/hi-im-renan.html" target="_self">About</a></li><li><a href="https://lecaro.me/" target="_self">Posts</a></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2021-03-24T16:49">March 24, 2021</time></div><h1> Be careful what you ping for</h1></div></header></div><div class="wrapper post__entry"><p>I have a setup to know when my main app, ciboulette.net, is down.</p><p>It's based on <a href="https://www.statuscake.com/">statuscake</a>, which pings my marketing site every 5 minutes, and also my main app. </p><figure class="post__image"><img loading="lazy" src="https://lecaro.me/media/posts/14/Screenshot-from-2021-03-24-15-23-56.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-xs.png 300w, https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-sm.png 480w, https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-md.png 768w, https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-lg.png 1024w, https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-xl.png 1360w, https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-2xl.png 1600w" alt="Screenshot of statuscake" width="649" height="271"></figure><p>It used to ping a third endpoint, which was an order form deep inside my app. </p><p>The idea was to check the the clients of my clients should be able to order veggies, so pinging a specific, real page would make sense.</p><p>I also used to log every action that would happen on such an order, directly in an array within the "order" document.</p><p>It means that every 5 minute, the document was getting a tiny bit bigger. </p><p>Today, i tried to mongorestore a production dump on my local dev environment to get fresh data. It's very useful to see how the real data would look like in the new version, and lets me see missuses and bugs that i would miss otherwise. </p><p>So i tried to import my production dump (the db needs renaming from "ciboulette" to "meteor" to work locally) </p><pre>renan@renan-hp:~/cl/app$ cat dump/daily_21-03-24.backup.gzip | mongorestore --archive --gzip  --nsFrom='ciboulette.*' --nsTo='meteor.*' --uri=mongodb://127.0.0.1:3001/<br>2021-03-24T15:31:06.076+0100 preparing collections to restore from<br>2021-03-24T15:31:06.083+0100 reading metadata for meteor.shortUrls from archive on stdin<br>2021-03-24T15:31:06.102+0100 restoring meteor.shortUrls from archive on stdin<br>2021-03-24T15:31:06.263+0100 reading metadata for meteor.opens from archive on stdin<br>2021-03-24T15:31:06.278+0100 restoring meteor.opens from archive on stdin<br>2021-03-24T15:31:06.753+0100 reading metadata for meteor.Orders from archive on stdin<br>2021-03-24T15:31:06.767+0100 restoring meteor.Orders from archive on stdin<br>2021-03-24T15:31:07.308+0100 reading metadata for meteor.logs from archive on stdin<br>2021-03-24T15:31:07.318+0100 restoring meteor.logs from archive on stdin<br>2021-03-24T15:31:07.827+0100 no indexes to restore<br>2021-03-24T15:31:07.827+0100 finished restoring meteor.shortUrls (8224 documents, 0 failures)<br>2021-03-24T15:31:08.269+0100 no indexes to restore<br>2021-03-24T15:31:08.269+0100 finished restoring meteor.opens (21263 documents, 0 failures)<br>2021-03-24T15:31:08.503+0100 finished restoring meteor.Orders (32999 documents, 1 failure)<br>2021-03-24T15:31:08.503+0100 Failed: <strong>meteor.Orders: error restoring from archive</strong> on stdin: bulk write error: [{[{<strong>write to oplog failed: BadValue: object to insert exceeds cappedMaxSize</strong>}]}, {&lt;nil&gt;}]<br>2021-03-24T15:31:08.503+0100 32999 document(s) restored successfully. 1 document(s) failed to restore.</pre><p>It took me quite a while to pinpoint the problem. </p><p>Luckily, the same dump would import fine in a real mongod instance, the problem seemed to be only with the meteor provided development mongo instance. </p><p>The problem seemed to be be with some order documents. </p><p>So, first i wiped the local "meteor" db in mongod</p><pre>mongo mongodb://127.0.0.1:27017/meteor --eval "db.dropDatabase()"</pre><p>Then i imported the dump there</p><pre>cat dump/daily_21-03-24.backup.gzip | mongorestore --archive --gzip  --nsFrom='ciboulette.*' --nsTo='meteor.*'</pre><p>I tried removing all documents from db.Orders, dumping, and then importing that to meteor, it worked. But i was missing my main collection.</p><p>I then used this script to find the biggest document and its _id within my mongo collection</p><pre> mongo  mongodb://127.0.0.1:27017/meteor --eval "(()=&gt;{var max=0,maxId=null; <strong>db.Orders</strong>.find().forEach(o=&gt;{var s=<strong>Object.bsonsize</strong>(o);if(s&gt;max){max=s;maxId=o._id}}); return {max,maxId}})()"<br><br>MongoDB server version: 4.4.4<br>{ <strong>"max" : 14199831</strong>, "maxId" : "GBeerkZ46dcjAgLtu" }</pre><p>14 199 831 bytes, holly molly ! About 14 megabytes of text in one document.</p><p>A findOne query allowed me to see that it was the "Order.logs" field that was so full.</p><p>So i cleaned up this field in  all documents :</p><pre>renan@renan-hp:~/cl/app$ mongo mongodb://127.0.0.1:27017/meteor --eval 'db.Orders.update({logs:{ $exists:true}},<strong>{$unset:{logs:""}},{multi:true}</strong>);'<br>MongoDB shell version v4.4.4<br>connecting to: mongodb://127.0.0.1:27017/meteor?compressors=disabled&amp;gssapiServiceName=mongodb<br>Implicit session: session { "id" : UUID("bb02fe49-5241-4beb-82ea-fbdc4c325998") }<br>MongoDB server version: 4.4.4<br>WriteResult({ "nMatched" : 180383, "nUpserted" : 0, <strong>"nModified" : 180383</strong> })</pre><p> And re-run the maximum size check </p><pre>mongo mongodb://127.0.0.1:27017/meteor --eval "(()=&gt;{var max=0,maxId=null; db.Orders.find().forEach(o=&gt;{var s=Object.bsonsize(o);if(s&gt;max){max=s;maxId=o._id}}); return {max,maxId}})()"<br>{ "max" : <strong>7578</strong>, "maxId" : "eYdGxbBKDNfKZYZw8" }</pre><p>Much, much better :)</p><p>So, all that was left was to dump that data, load the dump in meteor and all was fine.</p><p>I added a migration to clean that field in production too.  It will run on the next deploy. </p><p> </p></div></article></main><footer class="footer"><div class="footer__copyright"><p>+33 6 28 35 01 14 (Whatsapp only)</p><p><a href="mailto:renan.lecaro@gmail.com">renan.lecaro@gmail.com</a></p></div></footer></div><script async defer="defer" data-domain="lecaro.me" src="https://stats.lecaro.me/js/index.js"></script></body></html>