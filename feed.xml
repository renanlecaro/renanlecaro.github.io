<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Renan LE CARO</title>
    <link href="https://lecaro.me/feed.xml" rel="self" />
    <link href="https://lecaro.me" />
    <updated>2021-03-28T16:54:27+02:00</updated>
    <author>
        <name>Renan LE CARO</name>
    </author>
    <id>https://lecaro.me</id>

    <entry>
        <title>Github action to check for TODOs and FIXMEs</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/github-action-to-check-for-todos-and-fixmes.html"/>
        <id>https://lecaro.me/github-action-to-check-for-todos-and-fixmes.html</id>

        <updated>2021-03-28T16:54:27+02:00</updated>
            <summary>
                <![CDATA[
                    I had some TODO and FIXME instructions in random locations in my code that served no purpose, as I was never looking for them. I decided to now only use them as a "do this before deploying" kind of instruction. So i made a very&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I had some TODO and FIXME instructions in random locations in my code that served no purpose, as I was never looking for them. </p>
<p>I decided to now only use them as a "do this before deploying" kind of instruction.</p>
<p>So i made a very simple script that fails if there are any TODOs and FIXMEs in your code.</p>
<p>Save it in .github/workflows/check_todos.yml</p>
<pre>name: Look for TODOs and FIXMEs<br>on:<br>  pull_request:<br>    # only prevent merging to the production branch, todos in tests are fine<br>    branches:<br>      - master<br>jobs:<br>  build:<br>    runs-on: ubuntu-latest<br>    steps:<br>      - uses: actions/checkout@v2<br>      - run: |<br>         MATCHES=$(grep -rE "T[O]DO|F[I]XME")<br>         if [[ $MATCHES ]]<br>         then<br>           echo $MATCHES<br>           exit 1<br>         fi</pre>
<p>The weird T[O]DO and F[I]XME syntax is to avoid the script source triggering itself.</p>
<p>There's also a way to exclude .yml files from the search, but this lets you use the syntax everywhere as a "don't deploy this".  </p>
<p>The search is case sensitive, so it will only trip for clear TODOs and not some random method names.</p>
<p>You get the results really quickly, and because only the source is checked out ,all the generated files/packages should be excluded from the search.</p>
<figure class="post__image"><img loading="lazy"  src="https://lecaro.me/media/posts/21/Screenshot-from-2021-03-27-13-23-36.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://lecaro.me/media/posts/21/responsive/Screenshot-from-2021-03-27-13-23-36-xs.png 300w ,https://lecaro.me/media/posts/21/responsive/Screenshot-from-2021-03-27-13-23-36-sm.png 480w ,https://lecaro.me/media/posts/21/responsive/Screenshot-from-2021-03-27-13-23-36-md.png 768w ,https://lecaro.me/media/posts/21/responsive/Screenshot-from-2021-03-27-13-23-36-lg.png 1024w ,https://lecaro.me/media/posts/21/responsive/Screenshot-from-2021-03-27-13-23-36-xl.png 1360w ,https://lecaro.me/media/posts/21/responsive/Screenshot-from-2021-03-27-13-23-36-2xl.png 1600w"  alt="Screenshot of github output" width="1000" height="492"></figure>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Configuring i3 for headful e2e tests</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/configuring-i3-for-headful-e2e-tests.html"/>
        <id>https://lecaro.me/configuring-i3-for-headful-e2e-tests.html</id>

        <updated>2021-03-27T11:52:52+01:00</updated>
            <summary>
                <![CDATA[
                    i3 is nice. End to end tests are nice. Chromium is nice. But they don't get along so well by default. When you run you e2e script with nodemon, each run opens and closes the test browser window. By default, that window appears right by&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>i3 is nice. End to end tests are nice. Chromium is nice. But they don't get along so well by default.</p>
<p>When you run you e2e script with nodemon, <strong>each run opens and closes the test browser</strong> window. By default, that window appears <strong>right by your editor</strong>, messing the layout.</p>
<p>It's easy to fix though : you just need to <strong>tell i3 what to do with that test browser window</strong>.</p>
<p>To make every new chromium window appear in the workspace $ws5, add this in ~/.config/i3/config</p>
<p><code>assign [class="Chromium-browser"] → $ws5</code></p>
<p>The workspace name is a variable here, but you can put anything. I assign that window to a rarely used workspace. </p>
<p>Chromium has a different class from Google Chrome, so this has no impact on where the "real" browser is started.</p>
<p>To get the class infos for other browsers, run <code>xprop</code> in a terminal and then click on a window.  </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Using Trello for feature requests / priorisation </title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/using-trello-for-feature-requests-priorisation.html"/>
        <id>https://lecaro.me/using-trello-for-feature-requests-priorisation.html</id>

        <updated>2021-03-26T22:30:45+01:00</updated>
            <summary>
                <![CDATA[
                    I have a few users for my app, and 1000's of ideas on how to improve it. I've been tracking my work in trello, on a public board (my app is still closed source, but i'm as open as possible about the processes of my&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I have a few users for my app, and 1000's of ideas on how to improve it. </p>
<p>I've been tracking my work in trello, on a public board (my app is still closed source, but i'm as open as possible about the processes of my work). </p>
<figure class="post__image"><img loading="lazy"  src="https://lecaro.me/media/posts/19/Screenshot-from-2021-03-26-22-25-06.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://lecaro.me/media/posts/19/responsive/Screenshot-from-2021-03-26-22-25-06-xs.png 300w ,https://lecaro.me/media/posts/19/responsive/Screenshot-from-2021-03-26-22-25-06-sm.png 480w ,https://lecaro.me/media/posts/19/responsive/Screenshot-from-2021-03-26-22-25-06-md.png 768w ,https://lecaro.me/media/posts/19/responsive/Screenshot-from-2021-03-26-22-25-06-lg.png 1024w ,https://lecaro.me/media/posts/19/responsive/Screenshot-from-2021-03-26-22-25-06-xl.png 1360w ,https://lecaro.me/media/posts/19/responsive/Screenshot-from-2021-03-26-22-25-06-2xl.png 1600w"  alt="The development board" width="1913" height="925"></figure>
<p class="align-center">The <a href="https://trello.com/b/GaZSJzzq/planning-de-d%C3%A9veloppement-de-ciboulettenet">development board</a> (in French)</p>
<p>I'm the only one doing development work here, but I've invited my clients to join the board. I instructed them to just "join" any card that seems like it would be useful to them. I only invited paying customers. </p>
<p>It's a great way to focus on what's really needed. But i tend to work on some technical stuffs that don't really matter to them right now (like the <a href="https://lecaro.me/meteor-lags-aggregates-to-the-rescue.html">last post</a> about aggregation suggests) so I can't always prioritise what's asked. </p>
<p>And I get some Trello gold after every signup, but I'm not sure why I should care. </p>
<p>Ideally, I'd like something similar but integrated in my app, to let users voice their opinions and needs without friction, but I thought i'd postpone that to the time where all the cards with a person on it are already done. </p>
<p>And services like this already exist I guess, so it's not really worth investing much effort in creating a custom solution.  </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Meteor lags ? Aggregates to the rescue !</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/meteor-lags-aggregates-to-the-rescue.html"/>
        <id>https://lecaro.me/meteor-lags-aggregates-to-the-rescue.html</id>

        <updated>2021-03-26T22:21:33+01:00</updated>
            <summary>
                <![CDATA[
                    My app has 4 main collections in mongo : - A user has many weeks and clients - Each week has many orders, one per client, where the order content is stored (can be empty if the client didn't order that week). Initially, my documents&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>My app has 4 main collections in mongo : </p>
<p>- A <strong>user </strong>has many <strong>weeks </strong>and <strong>clients</strong></p>
<p>- Each week has many <strong>orders</strong>, one per client, where the order content is stored (can be empty if the client didn't order that week). </p>
<p>Initially, my documents were quite dry, I was doing the "joins" work on the client. It got laggy though, so I moved the joins logic to the meteor server, with <strong>hooks</strong> (<strong>matb33:collection-hooks) </strong>in every directions to keep denormalized fields in sync. </p>
<figure class="post__image"><img loading="lazy"  src="https://trello-attachments.s3.amazonaws.com/605b848835c8f765d6d4626e/1025x564/5235adb0e560fb8de807e8488b2e67ec/image.png" data-is-external-image="true"  alt="My mess of hooks, simplified, visualized" width="718" height="395"></figure>
<p>It was a pain though, really hard to follow what was going on and to debug. </p>
<p>There's also potential for chain reactions and never ending hooks loops. </p>
<p>But mostly, it was <strong>buggy in edge cases</strong>. </p>
<p>So I'm migrating away from those hooks, and creating an aggregation pipeline per collection (week, client, order) that computes all the dynamic fields for some given ids, and returns the documents where the value is different, plus some additional ids to check in the next pass. </p>
<p>It's not yet in production, but after this rewrite, my e2e tests are passing. </p>
<p>Meteor uses mongodb 4.2 in development server. I didn't feel like forcing an update to 4.4, which brings in two very useful features for my use case (the<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/function/"> $function</a> operator and the ability to <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#output-to-the-same-collection-that-is-being-aggregated">$merge</a> to the collection that you are aggregating on).</p>
<p>So I've been $writing:{ $some: {$nested: {$queries:'It's a pain''}}} . I'm back to junior level of mastery in this new paradigm, where "It works" comes as a surprise. I'm sure i'll rewrite those ugly aggregations at some point, but for now they seem to do the job. </p>
<p>One nice approach to using aggregation pipelines in meteor is to declare them in a separate js file, and then have a simple, non-meteor script that runs the aggregation and logs the results. </p>
<p>I use nodemon to watch the files, and get a very fast feedback loop, without the need to wait for the meteor server to recompile. Great when you're learning as you go. </p>
<p>I start the script like this (-r esm allows me to use modern imports) </p>
<pre>nodemon -e js  -r esm tests/scripts/mongofun.js</pre>
<p> And the script itself is very simple. It just runs the query </p>
<p>tests/scripts/mongofun.js :</p>
<pre>const mongoUrl='mongodb://127.0.0.1:3001/meteor'<br><br>async function actual_aggregation(db) {<br>  const result = await db<br>    .collection('Orders')<br>    .aggregate([<br>      {<br>        $match: {_id:'&lt;some test id&gt;'}<br>      }, <br>      ...the_pipeline_imported_from_the_meteor_source<br>    ])<br>    .toArray();<br>  console.log(result);<br>}<br><br>const mongodb = require('mongodb');<br>const client = new mongodb.MongoClient(mongoUrl, {<br>  useUnifiedTopology: true<br>});<br><br>client.connect().then(<br>  async () =&gt; {<br>    const start = Date.now();<br>    await author_aggregation(client.db());<br>    console.log('took ' + (Date.now() - start) + ' ms');<br>  },<br>  e =&gt; console.error(e)<br>);</pre>
<p>Anyway, that's all for today :)</p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Basic i3blocks controls for ubuntu rhythmbox</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/basic-i3blocks-controls-for-ubuntu-rhythmbox.html"/>
        <id>https://lecaro.me/basic-i3blocks-controls-for-ubuntu-rhythmbox.html</id>

        <updated>2021-03-26T22:22:27+01:00</updated>
            <summary>
                <![CDATA[
                    I've switched over from Spotify to Rhythmbox today. Spotify was a bit unstable on my system, it sometimes even struggled to playback offline playlists. I'm back to the good old "music" folder with files of long forgotten origins. The default ubuntu music player, rhythmbox, seems&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I've switched over from Spotify to Rhythmbox today. Spotify was a bit unstable on my system, it sometimes even struggled to playback offline playlists.</p>
<p>I'm back to the good old "music" folder with files of long forgotten origins.  </p>
<p>The default ubuntu music player, rhythmbox,  seems not too bad, i don't need it to do much anyway. </p>
<p>I just had to port my i3 bar script to : </p>
<ul>
<li>show the track currently playing</li>
<li>go to next track on right click</li>
<li>play/pause on left click<br><br></li>
</ul>
<p> </p>
<figure class="post__image align-center"><img loading="lazy"  src="https://lecaro.me/media/posts/17/i3script" alt="" width="478" height="53"></figure>
<p>The look of the "widget", pretty basic. </p>
<p>I wanted to add a play/pause icon but </p>
<ul>
<li>i didn't find a way to ask rhythmbox-client if the  music is played or paused</li>
<li>my ears are usually enough to know if anything i s playing </li>
</ul>
<p>I also added a little regexp to remove anything in parenthesis in the track name, to remove "(Original mix)" mentions and such. </p>
<p>.config/i3/i3blocks.conf :</p>
<pre>[music]<br>command=node ~/.config/i3/rhythmbox.js<br>interval=5</pre>
<p><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">The actual node script (I suck at bash, that's why i'm using node for this)</span></p>
<p><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">~/.config/i3/rhythmbox.js</span></p>
<pre><br>const {execSync}=require('child_process')<br><br>// apply click actions<br>switch(process.env.BLOCK_BUTTON){<br>  case  '1': execSync('rhythmbox-client --play-pause');<br>    break; <br>  case  '3': execSync('rhythmbox-client --next');<br>    break;<br>}<br><br>// get track name<br>const playing=(execSync('rhythmbox-client --print-playing').toString())||'';<br><br>// clean track name<br>const formatted=playing.replace(/\([^\)]+\)/gi,'')<br><br>// output it<br>console.log(formatted);</pre>
            ]]>
        </content>
    </entry>
    <entry>
        <title>3 video games I&#x27;ve spent 100+ hours on</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/3-video-games-ive-spend-100-hours-on.html"/>
        <id>https://lecaro.me/3-video-games-ive-spend-100-hours-on.html</id>

        <updated>2021-03-25T10:06:17+01:00</updated>
            <summary>
                <![CDATA[
                    I don't really play much those days, but I've had some great gaming experiences I felt like sharing today. This strategy game is free, ad free, and has an amazing replay-ability thanks to the user generated levels. It's easy to learn, and not too hard&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I don't really play much those days, but I've had some great gaming experiences I felt like sharing today.</p>
<table style="border-collapse: collapse; width: 100%;" border="0">
<tbody>
<tr>
<td style="width: 50%;"><figure class="post__image align-center"><img loading="lazy"  src="https://lecaro.me/media/posts/16/antiyoy.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://lecaro.me/media/posts/16/responsive/antiyoy-xs.png 300w ,https://lecaro.me/media/posts/16/responsive/antiyoy-sm.png 480w ,https://lecaro.me/media/posts/16/responsive/antiyoy-md.png 768w ,https://lecaro.me/media/posts/16/responsive/antiyoy-lg.png 1024w ,https://lecaro.me/media/posts/16/responsive/antiyoy-xl.png 1360w ,https://lecaro.me/media/posts/16/responsive/antiyoy-2xl.png 1600w"  alt="" width="240" height="400"></figure></td>
<td style="width: 50%;">
<h2>Antiyoy - Android</h2>
<p> This <strong>strategy</strong> game is free, ad free, and has an amazing replay-ability thanks to the user generated levels.  </p>
<p>It's <strong>easy to learn</strong>, and not too hard to master, after a while most levels are trivial. </p>
<p>Some get tough though, and I had to look at the solutions from random Russian Youtube videos at times. </p>
</td>
</tr>
<tr>
<td style="width: 50%;"><figure class="n3VNCb"><img loading="lazy"  src="https://i.ytimg.com/vi/J8SBp4SyvLc/maxresdefault.jpg" data-is-external-image="true"  alt="Factorio - Trailer 2020 - YouTube" data-noaft="1"></figure></td>
<td style="width: 50%;">
<h2>Factorio - Linux</h2>
<p>It's one of those game that's programmer's heaven. Or hell. It's very similar to <strong>programming</strong> (design, debugging, automating, constantly learning) <strong>but with guns</strong>.</p>
</td>
</tr>
<tr>
<td style="width: 50%;"><figure class="n3VNCb"><img loading="lazy"  src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ef/Nuclear_Throne_screenshot_10.png/1200px-Nuclear_Throne_screenshot_10.png" data-is-external-image="true"  alt="Nuclear Throne — Wikipédia" data-noaft="1"></figure></td>
<td style="width: 50%;">
<h2>Nuclear throne - Linux</h2>
<p>This is one of the <strong>roguelikes</strong> I sicked to, and after a while i got pretty good at it. <strong>Runs are short</strong>, so it's perfect to spend a few minutes before starting a complicated topic. It's frustrating enough that you don't end up playing 2 hours without realising it.  </p>
</td>
</tr>
</tbody>
</table>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Javascript minification with sed</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/javascript-minification-with-sed.html"/>
        <id>https://lecaro.me/javascript-minification-with-sed.html</id>

        <updated>2021-03-24T22:41:32+01:00</updated>
            <summary>
                <![CDATA[
                    I added a few of my projects to those "Pages under 1MB" websites. I'm not sure what for, but eh, it's free link estate ! Anyway, while most of those lists are comprised of boring, barely formatted text pages, i stumbled upon a nice one,&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I added a few of my projects to those "<a href="https://1mb.club/">Pages under 1MB</a>" websites. I'm not sure what for, but eh, it's free link estate !</p>
<p>Anyway, while most of those lists are comprised of <a href="https://jakob.kaivo.net/">boring</a>, barely formatted text pages,  i stumbled upon a nice one, this <a href="https://tutor.0b.ee/">touch type trainer</a> in 2 KB of js. The best thing about it  is not really the tool (it's limited, obviously) but the absurd way the author got down to that 2kb size, in particular this little gem. </p>
<p><a href="https://github.com/KaarelP2rtel/keyboard-tutor/blob/master/minify.sh">minify.sh</a> </p>
<pre>sed -i 's/tutor-window/tw/g' "$target"<br>sed -i 's/tutor-container/tc/g' "$target"<br>sed -i 's/tutor-completed/tm/g' "$target"<br>sed -i 's/tutor-cursor/tr/g' "$target"<br>sed -i 's/tutor-uncompleted/tu/g' "$target"<br>sed -i 's/tutor-result/te/g' "$target"<br>sed -i 's/tutor-status/ts/g' "$target"<br>sed -i 's/current-layout/cl/g' "$target"</pre>
<p>I have no words, it's beautiful :) </p>
<p>I remember going to similar extremes on <a href="https://github.com/renanlecaro/importabular/blob/master/src/index.js#L50">importabular</a>. </p>
<p>All the private methods had names prefixed by an underscore, and then i had some instructions for the minifying tool to not keep names with that prefix. </p>
<p>It shaved a few kilobytes from the already tiny lib, but i reverted it after to make it easier to subclass the Importabular class. </p>
<p> That period with the lower bars on <a href="https://bundlephobia.com/result?p=importabular@0.2.9">bundlephobia</a> is where this behavior was installed</p>
<p>Anyway, gzipped code golf is always a lot of fun. </p>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title> Be careful what you ping for</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/be-careful-what-you-ping-for.html"/>
        <id>https://lecaro.me/be-careful-what-you-ping-for.html</id>

        <updated>2021-03-24T15:49:39+01:00</updated>
            <summary>
                <![CDATA[
                    I have a setup to know when my main app, ciboulette.net, is down. It's based on statuscake, which pings my marketing site every 5 minutes, and also my main app. It used to ping a third endpoint, which was an order form deep inside my&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I have a setup to know when my main app, ciboulette.net, is down.</p>
<p>It's based on <a href="https://www.statuscake.com/">statuscake</a>, which pings my marketing site every 5 minutes, and also my main app. </p>
<figure class="post__image"><img loading="lazy"  src="https://lecaro.me/media/posts/14/Screenshot-from-2021-03-24-15-23-56.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-xs.png 300w ,https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-sm.png 480w ,https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-md.png 768w ,https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-lg.png 1024w ,https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-xl.png 1360w ,https://lecaro.me/media/posts/14/responsive/Screenshot-from-2021-03-24-15-23-56-2xl.png 1600w"  alt="Screenshot of statuscake" width="649" height="271"></figure>
<p>It used to ping a third endpoint, which was an order form deep inside my app. </p>
<p>The idea was to check the the clients of my clients should be able to order veggies, so pinging a specific, real page would make sense.</p>
<p>I also used to log every action that would happen on such an order, directly in an array within the "order" document.</p>
<p>It means that every 5 minute, the document was getting a tiny bit bigger. </p>
<p>Today, i tried to mongorestore a production dump on my local dev environment to get fresh data. It's very useful to see how the real data would look like in the new version, and lets me see missuses and bugs that i would miss otherwise. </p>
<p>So i tried to import my production dump (the db needs renaming from "ciboulette" to "meteor" to work locally) </p>
<pre>renan@renan-hp:~/cl/app$ cat dump/daily_21-03-24.backup.gzip | mongorestore --archive --gzip  --nsFrom='ciboulette.*' --nsTo='meteor.*' --uri=mongodb://127.0.0.1:3001/<br>2021-03-24T15:31:06.076+0100 preparing collections to restore from<br>2021-03-24T15:31:06.083+0100 reading metadata for meteor.shortUrls from archive on stdin<br>2021-03-24T15:31:06.102+0100 restoring meteor.shortUrls from archive on stdin<br>2021-03-24T15:31:06.263+0100 reading metadata for meteor.opens from archive on stdin<br>2021-03-24T15:31:06.278+0100 restoring meteor.opens from archive on stdin<br>2021-03-24T15:31:06.753+0100 reading metadata for meteor.Orders from archive on stdin<br>2021-03-24T15:31:06.767+0100 restoring meteor.Orders from archive on stdin<br>2021-03-24T15:31:07.308+0100 reading metadata for meteor.logs from archive on stdin<br>2021-03-24T15:31:07.318+0100 restoring meteor.logs from archive on stdin<br>2021-03-24T15:31:07.827+0100 no indexes to restore<br>2021-03-24T15:31:07.827+0100 finished restoring meteor.shortUrls (8224 documents, 0 failures)<br>2021-03-24T15:31:08.269+0100 no indexes to restore<br>2021-03-24T15:31:08.269+0100 finished restoring meteor.opens (21263 documents, 0 failures)<br>2021-03-24T15:31:08.503+0100 finished restoring meteor.Orders (32999 documents, 1 failure)<br>2021-03-24T15:31:08.503+0100 Failed: <strong>meteor.Orders: error restoring from archive</strong> on stdin: bulk write error: [{[{<strong>write to oplog failed: BadValue: object to insert exceeds cappedMaxSize</strong>}]}, {&lt;nil&gt;}]<br>2021-03-24T15:31:08.503+0100 32999 document(s) restored successfully. 1 document(s) failed to restore.</pre>
<p>It took me quite a while to pinpoint the problem. </p>
<p>Luckily, the same dump would import fine in a real mongod instance, the problem seemed to be only with the meteor provided development mongo instance. </p>
<p>The problem seemed to be be with some order documents. </p>
<p>So, first i wiped the local "meteor" db in mongod</p>
<pre>mongo mongodb://127.0.0.1:27017/meteor --eval "db.dropDatabase()"</pre>
<p>Then i imported the dump there</p>
<pre>cat dump/daily_21-03-24.backup.gzip | mongorestore --archive --gzip  --nsFrom='ciboulette.*' --nsTo='meteor.*'</pre>
<p>I tried removing all documents from db.Orders, dumping, and then importing that to meteor, it worked. But i was missing my main collection.</p>
<p>I then used this script to find the biggest document and its _id within my mongo collection</p>
<pre> mongo  mongodb://127.0.0.1:27017/meteor --eval "(()=&gt;{var max=0,maxId=null; <strong>db.Orders</strong>.find().forEach(o=&gt;{var s=<strong>Object.bsonsize</strong>(o);if(s&gt;max){max=s;maxId=o._id}}); return {max,maxId}})()"<br><br>MongoDB server version: 4.4.4<br>{ <strong>"max" : 14199831</strong>, "maxId" : "GBeerkZ46dcjAgLtu" }</pre>
<p>14 199 831 bytes, holly molly ! About 14 megabytes of text in one document.</p>
<p>A findOne query allowed me to see that it was the "Order.logs" field that was so full.</p>
<p>So i cleaned up this field in  all documents :</p>
<pre>renan@renan-hp:~/cl/app$ mongo mongodb://127.0.0.1:27017/meteor --eval 'db.Orders.update({logs:{ $exists:true}},<strong>{$unset:{logs:""}},{multi:true}</strong>);'<br>MongoDB shell version v4.4.4<br>connecting to: mongodb://127.0.0.1:27017/meteor?compressors=disabled&amp;gssapiServiceName=mongodb<br>Implicit session: session { "id" : UUID("bb02fe49-5241-4beb-82ea-fbdc4c325998") }<br>MongoDB server version: 4.4.4<br>WriteResult({ "nMatched" : 180383, "nUpserted" : 0, <strong>"nModified" : 180383</strong> })</pre>
<p> And re-run the maximum size check </p>
<pre>mongo mongodb://127.0.0.1:27017/meteor --eval "(()=&gt;{var max=0,maxId=null; db.Orders.find().forEach(o=&gt;{var s=Object.bsonsize(o);if(s&gt;max){max=s;maxId=o._id}}); return {max,maxId}})()"<br>{ "max" : <strong>7578</strong>, "maxId" : "eYdGxbBKDNfKZYZw8" }</pre>
<p>Much, much better :)</p>
<p>So, all that was left was to dump that data, load the dump in meteor and all was fine.</p>
<p>I added a migration to clean that field in production too.  It will run on the next deploy. </p>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Oh, the joy of Meteor e2e testing !</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/oh-the-joy-of-e2e-testing.html"/>
        <id>https://lecaro.me/oh-the-joy-of-e2e-testing.html</id>
            <category term="Blog post"/>

        <updated>2021-03-23T14:54:14+01:00</updated>
            <summary>
                <![CDATA[
                    I'm setting up e2e testing on my Meteor app, ciboulette.net. I had done it in the past but after large UI changes i just removed the tests as they were completely stale and generally painful to work with : I'm trying again, this time using&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I'm setting up e2e testing on my Meteor app, ciboulette.net.</p>
<p><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">I had done it in the past but after large UI changes i just removed the tests as they were completely stale and generally painful to work with : </span></p>
<ul>
<li>they were <strong>brittle and/or slow</strong></li>
<li>they were a <strong>pain to edit</strong>. </li>
<li>they didn't run in <strong>CI</strong></li>
</ul>
<p><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">I'm trying again, this time using <strong>playwright.</strong></span></p>
<p>To <strong>make the tests less brittle</strong>, i <span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">had to disable some of the "smarts" of the app to make the tests work at high speed  : </span></p>
<ul>
<li><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Instead of deferring heavy workloads, I run them synchronously before returning from a method.</span></li>
<li><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">My modal windows wait for the method result to come back from the server (no optimistic UI magic)</span></li>
<li><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">I had some logic to ignore double clicks that I had to disable in e2e mode</span></li>
<li>I completely mocked external services (google maps, google image, emails, sms, etc..)</li>
</ul>
<p>To <strong>make editing easier</strong>, I had to fix a few things :</p>
<ul>
<li>I start the e2e server with a different meteor local file, on a different port, with dedicated settings</li>
<li><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">I don't use the headful mode because it always start in the wrong place.</span></li>
<li>I take screenshots at every step, outputting the screenshot to one file that refreshes automatically when viewed with eog (eye of gnome) </li>
<li>I use nodemon to restart the tests when i change them (but not when I change any other file) </li>
<li>I start both my headless tests and eog with <strong><strong>npm-run-all</strong></strong></li>
</ul>
<p>Running the tests in <strong>github ci</strong></p>
<ul>
<li>The CI scrip uses <strong>start-server-and-test</strong> to start the meteor server in e2e mode and run the headless tests against it</li>
<li>The e2e Ci script runs<strong> npm install</strong>, but all other scripts run <strong>npm install --production</strong>. Playwright is heavy and is not required to build the app so i've added it as a devDependency. The unit tests are lightweight so i've added jest as a normal dependency.</li>
</ul>
<p>The <strong>remaining challenge</strong> I have is to create snapshots at different stages of the test (page url, db content, cookies) so that i can skip most of the e2e tests suite when editing a small part of it. It's tricky, involves hardcoded mongo urls, some mongorestore and mongodump run with execSync .. and not working yet. </p>
<p> </p>
<p>Extract of my package.json scripts :</p>
<pre>"e2e:server": "METEOR_LOCAL_DIR=.meteor/e2e  meteor --port 4000 --settings settings.e2e.json",<br>"e2e:cli:showImages": "eog tests/e2e/last-test-state.png",<br>"e2e:cli:nodemon": "SNAPALL=true nodemon  --watch tests/e2e/01_signup.js tests/e2e/01_signup.js",<br>"e2e:cli": "run-p e2e:cli:* ",<br>"e2e:ci:node": "node tests/e2e/01_signup.js ",<br>"e2e:ci": "start-server-and-test e2e:server http://localhost:4000 e2e:ci:node"</pre>
            ]]>
        </content>
    </entry>
    <entry>
        <title>My 3 favorite playlists : house, trance and funk</title>
        <author>
            <name>Renan LE CARO</name>
        </author>
        <link href="https://lecaro.me/my-3-favorite-playlists.html"/>
        <id>https://lecaro.me/my-3-favorite-playlists.html</id>
            <category term="Blog post"/>

        <updated>2021-03-23T14:54:09+01:00</updated>
            <summary>
                <![CDATA[
                    I have 3 playlists on Spotify I always come back to , thought i'd share them here Deep house as a background music for lightweight tasks, and as a loud playlist for festive events. Psychedelic trance when I need a motivation surge for a tough&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>I have 3 playlists on Spotify I always come back to , thought i'd share them here</p>
<ul>
<li><a href="https://open.spotify.com/playlist/4U1xZfxO1AsNbqWYKbfUnM?si=dTcARomPSLqMRaNHPvoWRw">Deep house</a> as a background music for lightweight tasks, and as a loud playlist for festive events.</li>
<li><a href="https://open.spotify.com/playlist/69gyd1SXiVhvfsyYS078f0?si=MnvGO1LTRhOy11neMwBHaQ">Psychedelic trance</a> when I need a motivation surge for a tough bit of code. It can get tiring after a few hours</li>
<li><a href="https://open.spotify.com/playlist/2BAkAh0GWqDwuSFEJsH1wJ?si=2y98meZORqaFBCfni2iwng">Low volume funk</a> for events which involve people I don't know the music taste of, and music is not the focus of  the event. It's selected so that the tracks don't overpower the soundscape and sound good even at a low volume. </li>
</ul>
            ]]>
        </content>
    </entry>
</feed>
